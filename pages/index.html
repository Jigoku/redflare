<!DOCTYPE html>
<html>
<head>
<title>Redflare - the Red Eclipse gaming monitor</title>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
<link href='http://fonts.googleapis.com/css?family=Prosto+One' rel='stylesheet' type='text/css'>
<link rel="stylesheet/less" type="text/css" href="/less/elements-0.6.less" />
<link rel="stylesheet/less" type="text/css" href="/less/theme-1.0.less" />
<link rel="stylesheet/less" type="text/css" href="/less/main-1.0.less" />
<script src="/js//underscore-1.3.1.min.js" type="text/javascript"></script>
<script src="/js/jquery-1.7.1.min.js" type="text/javascript"></script>
<script src="/js/less-1.3.0.min.js" type="text/javascript"></script>
<script src="/js/handlebars-1.0.0.beta.6.js" type="text/javascript"></script>
<script src="/js/pretty_date-1.0.js" type="text/javascript"></script>
<script src="/js/jquery.tablesorter-2.0.5b.min.js" type="text/javascript"></script>
</head>
<body>

<div class="banner">
  <h1>Redflare</h1>
  <h2>The <a href="http://www.redeclipse.net/" target="_blank">Red Eclipse</a> gaming monitor.
  </h2>
</div>
  
<div id="content" class="content">
  
</div>

<div class="footer">
  <p>Website and monitoring by <a href="http://sustainablesoftware.com.au/">Sustainable Software Pty Ltd</a> (a.k.a Mulex).</p>
  <p>Redflare uses open source software &mdash; available on Github [TODO]</p>
</div>

<script id="listing-template" type="text/x-handlebars-template">
  <h4>{{playerCount}} players on {{activeServerCount}} out of {{serverCount}} servers.</h4>
<table class="serverlist">
  <thead>
    <th>full%</th>
    <th>name</th>
    <th>players</th>
    <th>mutators</th>
    <th>game</th>
    <th>map</th>
    <th>ends in<br />(mins)</th>
    <th>access</th>
    <th>country</th>
    <th>seen</th>
  </thead>
  <tbody>
  {{#each reports}}
  <tr class="server {{cssClasses}}">
    <td class="full" style="border-right: solid {{heatColor}} 8px">{{fullness}}</td>
    <td class="name" style="width: 28em;">
      <a href="redeclipse://{{host}}:{{port}}/">{{description}}</a>
      {{#if names}}
      <br /><span class="players">{{names}}</span>
      {{/if}}
    </td>
    <td class="players">{{clients}}</td>
    <td style="text-align: right;">{{mutators}}</td>
    <td>{{gameMode}}</td>
    <td>{{mapName}}</td>
    <td>{{remaining}}</td>
    <td>{{masterMode}}</td>
    <td>{{country}}</td>
    <td>{{lastSeen}}</td>
  </tr>
  {{/each}}
  </tbody>
</table>
</script>

<script type="text/javascript"><!--

"use strict";

var listingTemplate = Handlebars.compile($("#listing-template").html());
var tableSortList = null;

function loadLatestReport() {
  var req = $.get('/reports');
  req.success(function(reports) {
    var playerCount = 0;
    var serverCount = 0;
    var activeServerCount = 0;
    var reportList = _.map(
      _.keys(reports),
      function(key) {
        var report = reports[key];
        playerCount = playerCount + report.clients;
        serverCount++;
        if (report.clients > 0) activeServerCount++;
        report.lastSeen = '' + prettyDate(-Math.round(((new Date()).getTime() - report.reported)/1000));
        var fullness = report.clients/report.maxClients;
        report.fullness = '' + Math.round(fullness*100) + '%';
        report.gameMode = report.gameMode;
        report.mutators = report.mutators.join('-');
        report.remaining = Math.round(report.timeLeft/60);
        var playerNames = _.map(report.playerNames, function(name) {
          return name.plain;
        });
        report.names = playerNames.join(', ');
        var cssClasses = [];
        if (report.clients == 0) {
          cssClasses.push('empty');
        } else if (report.clients == report.maxClients) {
          cssClasses.push('full');
        }
        if (report.masterMode != 'open') {
          cssClasses.push('notopen');
        }
        report.cssClasses = cssClasses.join(' ');
        var heatColorHSL = [
          180 + Math.round(fullness*180),
          '100%',
          (20 + Math.round(fullness*60)) + '%'
        ];
        if (fullness == 0) {
          report.heatColor = '#1c1c1c';
        } else if (fullness == 1) {
          report.heatColor = '#f00';
        } else {
          report.heatColor = 'hsl(' + heatColorHSL.join(', ') + ')';
        }
        return report;
      }
    );
    $('#content').html(listingTemplate(
      {
        reports : reportList,
        playerCount : playerCount,
        serverCount : serverCount,
        activeServerCount : activeServerCount
      }
    ));
    $('.serverlist').tablesorter({ 
      sortInitialOrder: 'desc',
      sortList: (tableSortList ? tableSortList : [[0,1]]),
      headers: { 
        9 : { sorter: false  }
      } 
    }).bind("sortEnd", function(sorter) {
      tableSortList = sorter.target.config.sortList;
    });
  });
}

loadLatestReport();
setInterval(loadLatestReport, 15*1000);
// -->
</script>
</body>
</html>
